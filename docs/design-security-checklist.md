# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ è¨­è¨ˆæ›¸

## Overview

Oaikoï¼ˆãŠã‚ã„ã“ï¼‰ã®ãƒªãƒªãƒ¼ã‚¹å‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªé …ç›®ã‚’ã¾ã¨ã‚ãŸãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€‚OWASP Top 10ã€Convex/Clerk ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€ãŠã‚ˆã³å…±æœ‰å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªå›ºæœ‰ã®ãƒªã‚¹ã‚¯ã‚’è€ƒæ…®ã—ãŸåŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã€‚

## Purpose

### ãªãœå¿…è¦ã‹

1. **é‡‘èãƒ‡ãƒ¼ã‚¿ã®æ©Ÿå¯†æ€§**
   - æ”¯å‡ºé‡‘é¡ã€ç²¾ç®—æƒ…å ±ãªã©ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è²¡å‹™çŠ¶æ³ã«é–¢ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†
   - ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã¯æ·±åˆ»ãªãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¾µå®³ã«ã¤ãªãŒã‚‹

2. **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ§‹é€ ã®ãƒªã‚¹ã‚¯**
   - è¤‡æ•°ã®ã‚°ãƒ«ãƒ¼ãƒ—ã€è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰
   - èªå¯ã®ä¸å‚™ã¯ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã«ç›´çµ

3. **ãƒªãƒªãƒ¼ã‚¹å‰ã®ç¶²ç¾…çš„ç¢ºèª**
   - é–‹ç™ºä¸­ã«è¦‹è½ã¨ã—ãŸè„†å¼±æ€§ã‚’ç™ºè¦‹
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æ„è­˜ã—ãŸé–‹ç™ºæ–‡åŒ–ã®ç¢ºç«‹

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²¬ä»»åˆ†æ‹…

```mermaid
flowchart TB
    subgraph "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤"
        Browser[ãƒ–ãƒ©ã‚¦ã‚¶]
        NextJS[Next.js App Router]
    end

    subgraph "èªè¨¼å±¤"
        Clerk[Clerk]
        Middleware[Next.js Middleware]
    end

    subgraph "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å±¤"
        Convex[Convex Functions]
        ConvexDB[(Convex DB)]
    end

    subgraph "ã‚¤ãƒ³ãƒ•ãƒ©å±¤"
        Vercel[Vercel]
        ConvexCloud[Convex Cloud]
    end

    Browser --> NextJS
    NextJS --> Middleware
    Middleware --> Clerk
    Clerk --> Convex
    Convex --> ConvexDB
    NextJS --> Vercel
    Convex --> ConvexCloud
```

| å±¤           | è²¬ä»»è€…          | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–                   |
| ------------ | --------------- | ---------------------------------- |
| ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | Next.js/React   | XSSè‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã€CSP             |
| èªè¨¼         | Clerk           | OAuthã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã€CSRFã€MFA   |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Convex + é–‹ç™ºè€… | èªå¯ãƒã‚§ãƒƒã‚¯ã€å…¥åŠ›æ¤œè¨¼ã€ã‚¯ã‚¨ãƒªåˆ¶é™ |
| ã‚¤ãƒ³ãƒ•ãƒ©     | Vercel/Convex   | DDoSä¿è­·ã€HTTPSã€æš—å·åŒ–            |

## What to Do

### æ©Ÿèƒ½è¦ä»¶ï¼šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

#### 1. èªè¨¼ï¼ˆAuthenticationï¼‰

| #   | ãƒã‚§ãƒƒã‚¯é …ç›®                               | å¯¾å¿œæ–¹æ³•                                  | è²¬ä»»  | çŠ¶æ…‹          |
| --- | ------------------------------------------ | ----------------------------------------- | ----- | ------------- |
| A-1 | å…¨ãƒšãƒ¼ã‚¸ã§èªè¨¼ãŒå¿…é ˆã‹                     | Next.js Middleware ã§å…¬é–‹ãƒ«ãƒ¼ãƒˆä»¥å¤–ã‚’ä¿è­· | Clerk | âœ… å®Ÿè£…æ¸ˆã¿   |
| A-2 | æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã¯é©åˆ‡ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã‹ | `auth.protect()` ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ           | Clerk | âœ… å®Ÿè£…æ¸ˆã¿   |
| A-3 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯å®‰å…¨ã‹                     | HttpOnly, Secure, SameSite Cookie         | Clerk | âœ… è‡ªå‹•       |
| A-4 | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã‹     | Clerkã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†                     | Clerk | âœ… è‡ªå‹•       |
| A-5 | å¤šè¦ç´ èªè¨¼ï¼ˆMFAï¼‰ã®æä¾›                    | Clerkã§è¨­å®šå¯èƒ½                           | Clerk | âš ï¸ è¦è¨­å®šç¢ºèª |

#### 2. èªå¯ï¼ˆAuthorizationï¼‰

| #   | ãƒã‚§ãƒƒã‚¯é …ç›®                                   | å¯¾å¿œæ–¹æ³•                          | è²¬ä»»   | çŠ¶æ…‹        |
| --- | ---------------------------------------------- | --------------------------------- | ------ | ----------- |
| Z-1 | Convexé–¢æ•°ã§èªè¨¼ãƒã‚§ãƒƒã‚¯ãŒã‚ã‚‹ã‹               | `authQuery` / `authMutation` ä½¿ç”¨ | é–‹ç™ºè€… | âœ… å®Ÿè£…æ¸ˆã¿ |
| Z-2 | ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ãŒãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ | å„é–¢æ•°ã§ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯    | é–‹ç™ºè€… | âš ï¸ è¦ç›£æŸ»   |
| Z-3 | ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ãŒå¿…è¦ãªæ“ä½œã¯åˆ¶é™ã•ã‚Œã¦ã„ã‚‹ã‹     | roleãƒã‚§ãƒƒã‚¯                      | é–‹ç™ºè€… | âš ï¸ éƒ¨åˆ†çš„   |
| Z-4 | é€€ä¼šå¾Œã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‹   | ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—å‰Šé™¤æ™‚ã®å‡¦ç†        | é–‹ç™ºè€… | ğŸ”´ æœªå®Ÿè£…   |
| Z-5 | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã¯è¦‹ãˆãªã„ã‹     | ã‚¯ã‚¨ãƒªã®ã‚¹ã‚³ãƒ¼ãƒ—åˆ¶é™              | é–‹ç™ºè€… | âš ï¸ è¦ç›£æŸ»   |

```mermaid
flowchart TD
    Request[ãƒªã‚¯ã‚¨ã‚¹ãƒˆ] --> Auth{èªè¨¼æ¸ˆã¿?}
    Auth -->|No| Reject1[æ‹’å¦: 401]
    Auth -->|Yes| GetUser[ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—]
    GetUser --> Member{ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼?}
    Member -->|No| Reject2[æ‹’å¦: 403]
    Member -->|Yes| Role{æ¨©é™ãƒã‚§ãƒƒã‚¯}
    Role -->|ä¸è¶³| Reject3[æ‹’å¦: 403]
    Role -->|OK| Execute[å‡¦ç†å®Ÿè¡Œ]
```

#### 3. å…¥åŠ›æ¤œè¨¼ï¼ˆInput Validationï¼‰

| #   | ãƒã‚§ãƒƒã‚¯é …ç›®                           | å¯¾å¿œæ–¹æ³•                      | è²¬ä»»   | çŠ¶æ…‹      |
| --- | -------------------------------------- | ----------------------------- | ------ | --------- |
| V-1 | Convexé–¢æ•°ã®å¼•æ•°ã«ãƒãƒªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹   | `v.string()`, `v.number()` ç­‰ | Convex | âœ… è‡ªå‹•   |
| V-2 | æ–‡å­—åˆ—é•·ã®åˆ¶é™ã¯ã‚ã‚‹ã‹                 | ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³        | é–‹ç™ºè€… | âš ï¸ éƒ¨åˆ†çš„ |
| V-3 | é‡‘é¡ã¯æ­£ã®æ•°ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹     | ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ             | é–‹ç™ºè€… | ğŸ”´ æœªå®Ÿè£… |
| V-4 | æ—¥ä»˜å½¢å¼ã¯æ­£ã—ã„ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ | ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼              | é–‹ç™ºè€… | ğŸ”´ æœªå®Ÿè£… |
| V-5 | IDã¯å­˜åœ¨ã™ã‚‹ã‚‚ã®ã‹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹ | DBå‚ç…§ãƒã‚§ãƒƒã‚¯                | é–‹ç™ºè€… | âš ï¸ éƒ¨åˆ†çš„ |

#### 4. ãƒ‡ãƒ¼ã‚¿ä¿è­·ï¼ˆData Protectionï¼‰

| #   | ãƒã‚§ãƒƒã‚¯é …ç›®                                 | å¯¾å¿œæ–¹æ³•                 | è²¬ä»»     | çŠ¶æ…‹      |
| --- | -------------------------------------------- | ------------------------ | -------- | --------- |
| D-1 | é€šä¿¡ã¯HTTPSã§æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹              | Vercel/Convexå¼·åˆ¶SSL     | ã‚¤ãƒ³ãƒ•ãƒ© | âœ… è‡ªå‹•   |
| D-2 | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹             | Convexå´ã§æš—å·åŒ–         | Convex   | âœ… è‡ªå‹•   |
| D-3 | æ©Ÿå¯†æƒ…å ±ãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¦ã„ãªã„ã‹           | ãƒ­ã‚°å†…å®¹ç¢ºèª             | é–‹ç™ºè€…   | âš ï¸ è¦ç¢ºèª |
| D-4 | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å†…éƒ¨æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¦‹ç›´ã— | é–‹ç™ºè€…   | âš ï¸ è¦ç¢ºèª |

#### 5. ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†

| #   | ãƒã‚§ãƒƒã‚¯é …ç›®                                     | å¯¾å¿œæ–¹æ³•              | è²¬ä»»   | çŠ¶æ…‹        |
| --- | ------------------------------------------------ | --------------------- | ------ | ----------- |
| S-1 | `.env*` ãŒgitignoreã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹              | `.gitignore` ç¢ºèª     | é–‹ç™ºè€… | âœ… è¨­å®šæ¸ˆã¿ |
| S-2 | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„ã‹ | ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼        | é–‹ç™ºè€… | âš ï¸ è¦ç¢ºèª   |
| S-3 | æœ¬ç•ªã¨é–‹ç™ºã§ç’°å¢ƒå¤‰æ•°ãŒåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‹           | Vercel/Convexç’°å¢ƒå¤‰æ•° | é–‹ç™ºè€… | âœ… åˆ†é›¢æ¸ˆã¿ |
| S-4 | ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ–¹é‡ãŒã‚ã‚‹ã‹         | é‹ç”¨ãƒ«ãƒ¼ãƒ«ç­–å®š        | é–‹ç™ºè€… | ğŸ”´ æœªç­–å®š   |

#### 6. OWASP Top 10 å¯¾å¿œ

| #    | ãƒªã‚¹ã‚¯                    | å¯¾å¿œçŠ¶æ³    | å‚™è€ƒ                       |
| ---- | ------------------------- | ----------- | -------------------------- |
| O-1  | Broken Access Control     | âš ï¸ è¦ç›£æŸ»   | èªå¯ãƒã‚§ãƒƒã‚¯ã®ç¶²ç¾…æ€§ç¢ºèª   |
| O-2  | Cryptographic Failures    | âœ… å¯¾å¿œæ¸ˆã¿ | TLSå¼·åˆ¶ã€Convexæš—å·åŒ–      |
| O-3  | Injection                 | âœ… å¯¾å¿œæ¸ˆã¿ | Convexã¯NoSQL+å‹å®‰å…¨ã‚¯ã‚¨ãƒª |
| O-4  | Insecure Design           | âš ï¸ è¦ç¢ºèª   | è¨­è¨ˆãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦           |
| O-5  | Security Misconfiguration | âš ï¸ è¦ç¢ºèª   | è¨­å®šé …ç›®ã®è¦‹ç›´ã—           |
| O-6  | Vulnerable Components     | âš ï¸ è¦ç¢ºèª   | ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç›£æŸ»         |
| O-7  | Authentication Failures   | âœ… å¯¾å¿œæ¸ˆã¿ | Clerkåˆ©ç”¨                  |
| O-8  | Data Integrity Failures   | âš ï¸ è¦ç¢ºèª   | æ›´æ–°ãƒ­ã‚°ç­‰                 |
| O-9  | Logging Failures          | ğŸ”´ æœªå®Ÿè£…   | ç›£æŸ»ãƒ­ã‚°æœªå®Ÿè£…             |
| O-10 | SSRF                      | âœ… ä½ãƒªã‚¹ã‚¯ | å¤–éƒ¨URLãƒ•ã‚§ãƒƒãƒãªã—        |

### éæ©Ÿèƒ½è¦ä»¶

| é …ç›®               | è¦ä»¶                                       |
| ------------------ | ------------------------------------------ |
| ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆ     | Convex/Vercelã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¶é™ã‚’åˆ©ç”¨        |
| ç›£æŸ»ãƒ­ã‚°           | é‡è¦æ“ä½œï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆã€ç²¾ç®—ç­‰ï¼‰ã®ãƒ­ã‚°è¨˜éŒ² |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ   | è„†å¼±æ€§ç™ºè¦‹æ™‚ã®å¯¾å¿œãƒ•ãƒ­ãƒ¼ç­–å®š               |
| ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–° | å®šæœŸçš„ãªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆæœˆæ¬¡ï¼‰               |

## How to Do It

### 1. èªå¯ãƒã‚§ãƒƒã‚¯ã®ç›£æŸ»

å…¨Convexé–¢æ•°ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã€èªå¯ãƒã‚§ãƒƒã‚¯ã®æœ‰ç„¡ã‚’ç¢ºèªã™ã‚‹ã€‚

```mermaid
flowchart LR
    subgraph "ç¾åœ¨ã®Convexé–¢æ•°"
        users[users.ts]
        groups[groups.ts]
        future[ä»Šå¾Œè¿½åŠ ã•ã‚Œã‚‹é–¢æ•°]
    end

    subgraph "ãƒã‚§ãƒƒã‚¯é …ç›®"
        C1[authQuery/authMutationä½¿ç”¨]
        C2[ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ç¢ºèª]
        C3[ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™ç¢ºèª]
        C4[ãƒªã‚½ãƒ¼ã‚¹æ‰€æœ‰è€…ç¢ºèª]
    end

    users --> C1
    groups --> C1
    groups --> C2
    groups --> C3
```

#### ç›£æŸ»å¯¾è±¡é–¢æ•°ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«  | é–¢æ•°             | èªè¨¼ | ãƒ¡ãƒ³ãƒãƒ¼ç¢ºèª     | æ¨©é™ç¢ºèª | çŠ¶æ…‹ |
| --------- | ---------------- | ---- | ---------------- | -------- | ---- |
| users.ts  | ensureUser       | âœ…   | -                | -        | OK   |
| groups.ts | create           | âœ…   | -                | -        | OK   |
| groups.ts | listMyGroups     | âœ…   | è‡ªå‹•ï¼ˆè‡ªåˆ†ã®ã¿ï¼‰ | -        | OK   |
| groups.ts | getDetail        | âœ…   | âœ…               | -        | OK   |
| groups.ts | createInvitation | âœ…   | âœ…               | âœ… owner | OK   |

### 2. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–

#### é‡‘é¡ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹

```typescript
// convex/lib/validators.ts ã«è¿½åŠ 
export const positiveAmountValidator = v.number();
// + ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯: amount > 0 && amount <= 100000000
```

#### æ—¥ä»˜ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¾‹

```typescript
// YYYY-MM-DDå½¢å¼ãƒã‚§ãƒƒã‚¯
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
```

### 3. ç›£æŸ»ãƒ­ã‚°ã®å®Ÿè£…ï¼ˆå°†æ¥ï¼‰

```mermaid
sequenceDiagram
    participant User
    participant Convex
    participant AuditLog

    User->>Convex: ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
    Convex->>Convex: å‡¦ç†å®Ÿè¡Œ
    Convex->>AuditLog: ãƒ­ã‚°è¨˜éŒ²
    Note over AuditLog: who, what, when, result
    Convex-->>User: æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
```

### 4. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç›£æŸ»

```bash
# è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
pnpm audit

# å®šæœŸçš„ã«å®Ÿè¡Œï¼ˆCI/CDã«çµ„ã¿è¾¼ã¿æ¨å¥¨ï¼‰
```

### 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

```typescript
// convex/__tests__/security/authorization.test.ts

describe("Authorization", () => {
  test("éãƒ¡ãƒ³ãƒãƒ¼ã¯ã‚°ãƒ«ãƒ¼ãƒ—è©³ç´°ã‚’å–å¾—ã§ããªã„", async () => {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼AãŒã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼BãŒã‚°ãƒ«ãƒ¼ãƒ—è©³ç´°å–å¾—ã‚’è©¦ã¿ã‚‹
    // â†’ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
  });

  test("ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚‚ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã¯ç·¨é›†ã§ããªã„", async () => {
    // ...
  });
});
```

## What We Won't Do

### MVPå¤–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

| é …ç›®                         | ç†ç”±                              |
| ---------------------------- | --------------------------------- |
| ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ       | å°‚é–€çŸ¥è­˜ã¨è²»ç”¨ãŒå¿…è¦ã€MVPå¾Œã«æ¤œè¨ |
| WAFå°å…¥                      | Vercel/Convexã®æ¨™æº–ä¿è­·ã§ååˆ†     |
| IPã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶é™               | ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¢ãƒ—ãƒªã®ãŸã‚ä¸è¦  |
| ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ï¼ˆã‚¢ãƒ—ãƒªãƒ¬ãƒ™ãƒ«ï¼‰ | Convexã®ã‚¤ãƒ³ãƒ•ãƒ©æš—å·åŒ–ã§ååˆ†      |
| ç›£æŸ»ãƒ­ã‚°ã®é•·æœŸä¿å­˜           | MVPå¾Œã«æ¤œè¨                       |
| SIEMé€£æº                     | å€‹äººãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯éå‰°          |
| ãƒã‚°ãƒã‚¦ãƒ³ãƒ†ã‚£ãƒ—ãƒ­ã‚°ãƒ©ãƒ      | MVPå¾Œã«æ¤œè¨                       |

### å¯¾å¿œã‚’è¦‹é€ã‚‹ãƒªã‚¹ã‚¯

| ãƒªã‚¹ã‚¯               | å¯¾å¿œè¦‹é€ã‚Šç†ç”±                      |
| -------------------- | ----------------------------------- |
| ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ | Clerkã®100å›å¤±æ•—ãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã§å¯¾å¿œ  |
| ãƒœãƒƒãƒˆæ”»æ’ƒ           | Clerkã®AIãƒ™ãƒ¼ã‚¹ãƒœãƒƒãƒˆä¿è­·ã§å¯¾å¿œ     |
| DDoS                 | Vercel/Cloudflareã®ã‚¨ãƒƒã‚¸ä¿è­·ã§å¯¾å¿œ |

## Concerns

### æ‡¸å¿µäº‹é …ã¨å¯¾ç­–

| æ‡¸å¿µ                   | ãƒªã‚¹ã‚¯                       | å¯¾ç­–                                   |
| ---------------------- | ---------------------------- | -------------------------------------- |
| èªå¯ãƒã‚§ãƒƒã‚¯æ¼ã‚Œ       | ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ | é–¢æ•°è¿½åŠ æ™‚ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½“åˆ¶ã€ãƒ†ã‚¹ãƒˆå¿…é ˆåŒ– |
| ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è„†å¼±æ€§ | æ—¢çŸ¥ã®è„†å¼±æ€§ãŒæ‚ªç”¨ã•ã‚Œã‚‹     | å®šæœŸçš„ãª`pnpm audit`å®Ÿè¡Œ               |
| Clerk/Convexã®éšœå®³     | ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨ä¸å¯             | å¤–éƒ¨ä¾å­˜ã®ãŸã‚å—å®¹ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°       |
| ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¼æ´©     | ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹                 | gitignoreå¾¹åº•ã€ç’°å¢ƒå¤‰æ•°ç®¡ç†            |

### æœªè§£æ±ºã®ç–‘å•

| ç–‘å•                 | æ¤œè¨çŠ¶æ³                                     |
| -------------------- | -------------------------------------------- |
| MFAã‚’å¿…é ˆã«ã™ã‚‹ã‹    | ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã€‚ä»»æ„è¨­å®šã§é–‹å§‹     |
| é€€ä¼šæ©Ÿèƒ½ã®å®Ÿè£…æ–¹é‡   | ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ vs åŒ¿ååŒ–ã€GDPRã‚’è€ƒæ…®ã—ã¦è¨­è¨ˆå¿…è¦ |
| ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒæœŸé–“ | æ³•çš„è¦ä»¶ç¢ºèªãŒå¿…è¦                           |

### ãƒªãƒªãƒ¼ã‚¹å‰å¿…é ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³

```mermaid
flowchart TD
    A[èªå¯ãƒã‚§ãƒƒã‚¯ç›£æŸ»] --> B[å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ]
    B --> C[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè¿½åŠ ]
    C --> D[ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç›£æŸ»]
    D --> E[æœ¬ç•ªç’°å¢ƒå¤‰æ•°ç¢ºèª]
    E --> F[ãƒªãƒªãƒ¼ã‚¹]

    style A fill:#ff9,stroke:#333
    style B fill:#ff9,stroke:#333
    style C fill:#ff9,stroke:#333
    style D fill:#ff9,stroke:#333
    style E fill:#ff9,stroke:#333
```

## Reference Materials/Information

### Convex ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- [Authorization Best Practices](https://stack.convex.dev/authorization) - Convexèªå¯ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- [Row Level Security](https://stack.convex.dev/row-level-security) - è¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å®Ÿè£…
- [Best Practices | Convex Developer Hub](https://docs.convex.dev/understanding/best-practices/) - å…¬å¼ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- [Authentication Best Practices: Convex, Clerk and Next.js](https://stack.convex.dev/authentication-best-practices-convex-clerk-and-nextjs) - èªè¨¼çµ±åˆã‚¬ã‚¤ãƒ‰

### Clerk ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- [Next.js Authentication](https://clerk.com/nextjs-authentication) - Next.jsèªè¨¼ã‚¬ã‚¤ãƒ‰
- [Complete Authentication Guide for Next.js App Router](https://clerk.com/articles/complete-authentication-guide-for-nextjs-app-router) - App Routerèªè¨¼ã‚¬ã‚¤ãƒ‰

### OWASP

- [OWASP Top Ten](https://owasp.org/www-project-top-ten/) - Webã‚¢ãƒ—ãƒªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãƒˆãƒƒãƒ—10
- [OWASP Top Ten 2025](https://www.owasptopten.org/) - æœ€æ–°ç‰ˆï¼ˆ2025å¹´äºˆå®šï¼‰

### ä¸€èˆ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- Verizon 2024 Data Breach Investigations Report - èªè¨¼æƒ…å ±çªƒå–ãŒä¾µå®³ã®38%ã‚’å ã‚ã‚‹
- Microsoft MFAèª¿æŸ» - ä¾µå®³ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®99.9%ãŒMFAæœªè¨­å®š

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜       | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
| ---------- | -------- | ------ |
| 2024-12-30 | åˆç‰ˆä½œæˆ | Claude |
